<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>The Continuity Equation and Benamou Brenier Formula – OT WIKI</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-6bd9cfa162949bde0a231f530c97869d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">OT WIKI</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">The Continuity Equation and Benamou Brenier Formula</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Christian Hong and Djordje Nikolic </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>The continuity equation is an important equation in many fields of science, for example, electromagnetism, computer vision, fluid dynamics etc. However, in the field of optimal transport, the formulation from fluid dynamics is of a large significance. This form helps to explain the dynamic formulation of special cases of <a href="https://en.wikipedia.org/wiki/Wasserstein_metric">Wasserstein metric</a> via the continuity equation, and we will focus in this direction. Related to this is the Benamou-Brenier Formula, which implies a Riemannian structure on our space of measures. For more general information about the continuity equation, look at the article <a href="https://en.wikipedia.org/wiki/Continuity_equation">Continuity equation</a>.</p>
</section>
<section id="continuity-equation-in-fluid-dynamics" class="level2">
<h2 class="anchored" data-anchor-id="continuity-equation-in-fluid-dynamics">Continuity equation in fluid dynamics</h2>
<p>First, because of the intuition, we will introduce the definition of the continuity equation in fluid mechanics. The exposition in this section will follow the book by Chorin and Marsden<ref name="Marsden">.</ref></p>
<p>Suppose that mass of our fluid is conserved, through time. Denote <span class="math inline">\(\rho(x,t)\)</span> as a density function, representing the mass-density of fluid, and <span class="math inline">\(v(x,t)\)</span> as a velocity of particle at position <span class="math inline">\(x\)</span>, at time <span class="math inline">\(t\)</span>. Then, for any subspace <span class="math inline">\(W\)</span> of <span class="math inline">\(\mathbb{R}^{3}\)</span> we have: :<span class="math inline">\(\partial_{t}[\int_{W} \rho(x,t) dV] = - \int_{\partial W} \rho v \cdot ndS.\)</span></p>
<p>In this section, we assume both density function and particle velocity are smooth enough. Hence, after differentiating under the integral and applying the Divergence Theorem, we get: :<span class="math inline">\(\int_{W} \partial_{t}\rho(x,t) dV = - \int_{W} \nabla\cdot(\rho v) dV.\)</span></p>
<p>Finally, we conclude that: :<span class="math inline">\(\int_{W} \partial_{t}\rho + \nabla\cdot(\rho v) dV = 0,\)</span> which implies, since <span class="math inline">\(W\)</span> is arbitrary, that: :<span class="math inline">\(\partial_{t}\rho + \nabla\cdot(\rho v) = 0.\)</span> The last equation is the continuity equation in fluid dynamics, written in the differential form. We use the equation in this form in optimal transport.</p>
<p>An important perspective comes from viewing the fluid as an system of particles moving in space (Langrangian perspective), as opposed to some continuous density that varies at specific points (Eulerian perspective) due to internal currents. This alternate perspective can be formalized via an ordinary differential equation<ref name="Ambrosio">. :<math></math></ref></p>
<span class="math display">\[\begin{cases}
\gamma'(t) = v(\gamma(t), t) &amp; \\
\gamma(0) = x &amp;
\end{cases}\]</span>
<p> where <span class="math inline">\(v(x,t)\)</span> is some vector field varying with time, and <span class="math inline">\(\gamma(t)\)</span> is absolutely continuous. Since we are not assuming our curve is differentiable, we can instead consider the integral form of our ODE :<span class="math inline">\(\gamma(t) = x + \int_0^t v_s(\gamma(s)) \, ds\)</span> In both cases, <span class="math inline">\(x\)</span> represents the starting point of our curve, which indicates the path of a specific particle in our fluid. The important fact is that the continuity equation and our ODE system are equivalent in a weak sense when given the same <span class="math inline">\(v(x, t)\)</span>. Intuitively, the continuity equation is stating the the change in density at a point is dictated by the flow of particles, <span class="math inline">\(\rho \cdot v(x,t)\)</span> into that point. From the Lagrangian point of view, this flow is the result of all the trajectories of particles that follow the current <span class="math inline">\(v(x,t)\)</span> into the desired point.</p>
</section>
<section id="continuity-equation-in-optimal-transport" class="level2">
<h2 class="anchored" data-anchor-id="continuity-equation-in-optimal-transport">Continuity equation in optimal transport</h2>
<p>The previous discussion assumed that the density function was smooth, which is not true of the general measures we consider in optimal transport. Even when a measure <span class="math inline">\(\mu\)</span> is absolutely continuous with respect to Lebesgue measure, which we write with a mild abuse of notation as <span class="math inline">\(d\mu(x) = \mu(x) dx\)</span>, <span class="math inline">\(\mu\)</span> does not have to be smooth. So, we need to state a proper weak formulation of the continuity equation. Smooth functions satisfy all the cases below.</p>
<p>Here, we will present definitions and reasoning from book by F.Santambrogio<ref name="Santambrogio">.</ref></p>
<p>From this point, we are looking at the following equation: :<span class="math inline">\(\partial_{t}\mu_{t} + \nabla\cdot (\mu_{t}v_{t}) = 0.\)</span></p>
<p>We will give two different notions of solutions to the continuity equation.</p>
<p>:* <strong>Distributional solution.</strong> All the measures we are interested in satisfy <span class="math inline">\(\int_{0}^{1} ||v_{t}||_{L^{1}(\mu_{t})}dt &lt; \infty\)</span>, and solve continuity equation in a distributional sense, namely :<span class="math inline">\(\int_{0}^{T}\int_{\Omega} [\partial_{t}\phi + \nabla\phi\cdot v_{t}] d\mu_{t} dt = 0,\)</span> for all bounded Lipschitz functions <span class="math inline">\(\phi \in C_{c}^{1}((0,T) \times \overline{\Omega})\)</span>, where <span class="math inline">\(\Omega\)</span> is a bounded domain or the whole space <span class="math inline">\(\mathbb{R}^{d}\)</span>, and <span class="math inline">\(0&lt;T&lt;1\)</span>. We assume no-flux condition in this case, namely <span class="math inline">\(\mu_{t}v_{t} \cdot n = 0\)</span> on the boundary <span class="math inline">\(\partial\Omega.\)</span> This notion of solution is called a <em>distributional</em> solution.</p>
<p>The main goal of the classical optimal transport theory is how to find the least expensive way to move one measure to the another one. For more information, look at <a href="http://34.106.105.83/wiki/Monge_Problem">Monge Problem</a>.So, we have to impose initial and terminal conditions on measures, for example <span class="math inline">\(\mu_{0} = \mu\)</span>, and <span class="math inline">\(\mu_{1} = \nu.\)</span> Then, our equation becomes <span class="math inline">\(\int_{0}^{T}\int_{\Omega} [\partial_{t}\phi + \nabla\phi\cdot v_{t}] d\mu_{t} dt = \int_{\Omega}\phi(T,x)d\nu(x) - \int_{\Omega}\phi(0,x)d\mu(x),\)</span> for all <span class="math inline">\(\phi \in C_{c}^{1}([0,T]\times \overline{\Omega}).\)</span></p>
<p>:* <strong>Weak solution.</strong> Another way to interpret solutions to the continuity equation is to assume that function <span class="math inline">\(t \rightarrow \int_{\Omega} \psi d\mu_{t}\)</span> is absolutely continuous, and for a.e. <span class="math inline">\(t\)</span> it holds: <span class="math inline">\(\partial_{t} \int_{\Omega} \psi d\mu_{t} = \int_{\Omega} \nabla\psi \cdot v_{t}d\mu_{t},\)</span> for all test functions <span class="math inline">\(\psi \in C_{c}^{1}(\overline{\Omega})\)</span> This kind of solution is called a <em>weak</em> solution.</p>
<dl>
<dt>Some connections between these two types of solutions are given in the following propositions.</dt>
<dd>
<p><strong>Proposition 1.</strong>, (p.124,<ref name="Santambrogio">) Distributional and weak solutions are equivalent. Every weak solution is a distributional solution. On the other hand, every distributional solution admits a representative (a.e. equal), that is weakly continuous and a weak solution.</ref></p>
</dd>
<dd>
<p><strong>Proposition 2.</strong>,(p.124,<ref name="Santambrogio">) Let <span class="math inline">\(\mu\)</span> be the Lipschitz function in <span class="math inline">\((t,x)\)</span> and <span class="math inline">\(v\)</span> be the Lipschitz function in <span class="math inline">\(x.\)</span> Suppose that the continuity equation is satisfied in the weak sense. Then it is satisfied in a.e. sense.</ref></p>
</dd>
<dt>The following theorem will provide us with existence and uniqueness of the continuity equation solution. For simplicity, we will assume that <span class="math inline">\(\Omega = \mathbb{R}^{d}.\)</span></dt>
<dd>
<p><strong>Theorem.</strong><ref name="Santambrogio"> Let measurable function <span class="math inline">\(v: (0,T) \times \mathbb{R}^{d} \rightarrow \mathbb{R}^{d}\)</span> be a Lipschitz continuous in <span class="math inline">\(x\)</span>, uniformly in <span class="math inline">\(t\)</span>, and uniformly bounded. Suppose that flow <span class="math inline">\(X_{t}\)</span> of the classical ODE problem, with function <span class="math inline">\(v\)</span> exists. Then, for any probability measure <span class="math inline">\(\mu_{0}\)</span>, push-forward measures <span class="math inline">\(\mu_{t} = X_{t}\#\mu_{0}\)</span> satisfy the continuity equation with the initial condition <span class="math inline">\(\mu_{0}\)</span>. Moreover, for all measures <span class="math inline">\(\mu_{t}\)</span> absolutely continuous with respect to Lebesgue measure, the previous solution is the only solution the continuity equation admits.</ref></p>
</dd>
<dd>
<p><em>Sketch of the Proof.</em> Proving existence, or checking that <span class="math inline">\(\mu_{t}\)</span> satisfies the continuity equation in a sense of the weak solution is straightforward, using change of variables in the integral. However, resolving the uniqueness of this solution when it is absolutely continuous with respect to Lebesgue measure requires narrowing a test function space, using distributional solution. Hence, we can control the flow <span class="math inline">\(X_{t}\)</span> in a better way, and using a linear transport equation solution, we can prove the uniqueness of solution of our continuity equation.</p>
</dd>
</dl>
</section>
<section id="applications" class="level2">
<h2 class="anchored" data-anchor-id="applications">Applications</h2>
<dl>
<dt>The following theorem can be found at the book by L.Ambrosio, E.Brué, and D.Semola<ref name="Ambrosio">.</ref></dt>
<dd>
<p><strong>Theorem (Benamou-Brenier Formula).</strong><ref name="Ambrosio"> Let <span class="math inline">\(\mu, \nu \in \mathcal{P}_{2}(\mathbb{R}^{d})\)</span>. Then :<span class="math inline">\(W_{2}^{2}(\mu, \nu)=\min_{(\mu(t),\nu(t))} \{\int_{0}^{1} |v(\cdot,t)|_{L^{2}(\mu(t))}^{2}dt \quad | \quad \partial_{t}\mu+\nabla\cdot(v\mu)=0,\quad \mu(0)=\mu,\quad \mu(1)=\nu \}.\)</span></ref></p>
</dd>
</dl>
<p>This formula is important for defining the Riemannian structure of our Wasserstein space. In particular, this is related to the fact that the distance minimizing curves on Riemannian manifolds are geodesics. The property at play here is the fact that geodesics minimize the action of the Riemannian metric. In other words, an optimal transport plan between measures <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\nu\)</span> is actually related to a geodesic connecting these measures on a Riemannian manifold. The Benamou-Brenier Formula implies that the correct action on this space is <span class="math inline">\(\min_{(\mu(t),\nu(t))} \int_{0}^{1} |v(\cdot,t)|_{L^{2}(\mu(t))}^{2}dt\)</span> where <span class="math inline">\(v(\cdot, t)\)</span> gives the velocity of the curve <span class="math inline">\(\mu\)</span>. This implies the correct Riemannian metric for our Wasserstein space. You can see more at <a href="http://34.106.105.83/wiki/Formal_Riemannian_Structure_of_the_Wasserstein_metric">Formal Riemannian Structure of the Wasserstein metric</a>.</p>
<p>In addition, using the continuity equation we can describe geodesics in the Wasserstein space. For more details look at <a href="http://34.106.105.83/wiki/Geodesics_and_generalized_geodesics">Geodesics and generalized geodesics</a>.</p>
</section>
<section id="references" class="level1">
<h1>References</h1>
<p><references></references></p>
<p><ref name="Marsden"> <a href="https://link.springer.com/book/10.1007/978-1-4612-0883-9">A.J.Chorin, J.E.Marsden, <em>A Mathematical Introduction to Fluid Mechanics</em>, Chapter 1, pages 1-11</a> </ref></p>
<p><ref name="Santambrogio"> <a href="https://link.springer.com/book/10.1007/978-3-319-20828-2">F.Santambrogio, <em>Optimal Transport for Applied Mathematicians</em>, Chapter 4, pages 123-126</a> </ref></p>
<p><ref name="Ambrosio"> <a href="https://link.springer.com/book/10.1007/978-3-030-72162-6">L.Ambrosio, E.Brué, D.Semola, <em>Lectures on Optimal Transport</em>, Lecture 16.1., pages 183-189</a> </ref></p>
<p></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/otwiki\.xyz");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>